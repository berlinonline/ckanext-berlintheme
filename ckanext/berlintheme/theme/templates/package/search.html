{% extends "page.html" %}
{% import 'macros/form.html' as form %}
{% set query = q %}
{% set placeholder = _('Search ' + dataset_type + 's') + '…' %}
{% set type = dataset_type %}
{% set sorting_selected = sort_by_selected %}
{% set count = page.item_count %}
{% set show_empty = request.params %}
{% set error = query_error %}
{% set facets = {
  'fields': fields_grouped,
  'search': search_facets,
  'titles': facet_titles,
  'translated_fields': translated_fields,
  'remove_field': remove_field }
%}
{% set sorting = [
  (_('Relevance'), 'score desc, metadata_modified desc'),
  (_('Name Ascending'), 'title_string asc'),
  (_('Name Descending'), 'title_string desc'),
  (_('Last Modified'), 'metadata_modified desc'),
  (_('Popular'), 'views_recent desc') if g.tracking_enabled else (false, false) ]
%}

{% block subtitle %}{{ _(dataset_type.title()) }}{% endblock %}

{% block breadcrumb_content %}
  <li class="active">{{ h.nav_link(_(dataset_type.title() + 's'), named_route='%s.search' % dataset_type, highlight_actions = 'new index') }}</li>
{% endblock %}

{% block grid_pre_herounit %}
  <form id="dataset-search-form" method="get" data-module="select-switch">
  {% block search_search_fields %}
    {# These are the invisible fields that we need to include the selected facets (which do not exist as form elements) on submitting the form. #}
    {% if fields -%}
      <span>{{ form.hidden_from_list(fields=fields) }}</span>
    {%- endif %}
{% endblock search_search_fields %}

{% endblock grid_pre_herounit %}

{% block grid_herounit %}
  {% block page_primary_action %}
    {% if h.check_access('package_create') %}
      <div class="page_primary_action">
        {{ h.snippet ('snippets/add_dataset.html', dataset_type=dataset_type) }}
      </div>
    {% endif %}
  {% endblock page_primary_action %}
  <div class="searchform-slot ">
    <div class="form-group">
      <label class="aural" for="dataset_fulltext_search">Suchbegriff</label>
      <div class="searchterm">
        <div class="input-wrapper">
          <i class="fas fa-search lens" aria-hidden="true"></i>
          <input id="dataset_fulltext_search" class="form-control search" type="text" name="q" value="{{ query }}" autocomplete="off" placeholder="{{ placeholder }}">
        </div>
        <button class="button button--clean submit " type="submit" title="Suchen">
          <span class="aural">Suchen</span><i class="fas fa-arrow-right icon" aria-hidden="true"></i>
        </button>
      </div>
    </div>
  </div>
{% endblock grid_herounit %}


{% block primary_content %}
  <div class="fullwidth panel--heavy">
    <div class="fullwidth__inner">
      <div class="row">
        <div class="span4">
          <button class="button button--filter js-facetingform-toggler" data-containerid="facetingform">Filter</button> 
          <div class="filters modul-facetingform js-facetingform initialized isOverlayPalm isHidden" id="facetingform" style="display: none;">
            <div class="facetingform__background" style="position: absolute; inset: 0px; background: rgba(0, 0, 0, 0.5);"></div>
            <div class="facetingform__container">
              <div class="container__head">
                <h2 class="title">Facettierung</h2>
                <button type="button" class="button button--clean close" aria-label="Filter schließen"><i class="bicon bicon-times bicon-2x" aria-hidden="true"></i></button>
              </div>
              <div class="container__body">
                <div class="facets">
                  {% for facet in facet_titles %}
                    {{ h.snippet('snippets/facet_list.html', title=facet_titles[facet], name=facet, search_facets=search_facets) }}
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="span8">
          <div class="dp-search-result-top">
            <div class="dp-search-result-summary">
              {% block search_title %}
                {% if not error %}
                  {% snippet 'snippets/search_result_text.html', query=query, count=count, type=type %}
                {% else %}
                  {{ _('Error') }}
                {% endif %}
              {% endblock search_title %}
            </div>
            <div class="dp-search-result-sort">
              {% block search_sortby %}
                {% if sorting %}
                  <div class="form-select form-group control-order-by">
                    <label for="field-order-by">{{ _('Order by') }}</label>
                    <select id="field-order-by" name="sort" class="form-control">
                      {% for label, value in sorting %}
                        {% if label and value %}
                          <option value="{{ value }}"{% if sorting_selected == value %} selected="selected"{% endif %}>{{ label }}</option>
                        {% endif %}
                      {% endfor %}
                    </select>
                    {% block search_sortby_button %}
                    <button class="btn btn-default js-hide" type="submit">{{ _('Go') }}</button>
                    {% endblock search_sortby_button %}
                  </div>
                {% endif %}
              {% endblock search_sortby%}
            </div>
          </div>
          {% block search_facets %}
            {% if facets %}
              <p class="filter-list">
                {% for field in facets.fields %}
                  {% set search_facets_items = facets.search.get(field)['items'] if facets.search and field in facets.search else [] %}
                  <span class="facet">{{ facets.titles.get(field) }}:</span>
                  {% for value in facets.fields[field] %}
                    <span class="filtered pill">
                      {%- if facets.translated_fields and (field,value) in facets.translated_fields -%}
                        {{ facets.translated_fields[(field,value)] }}
                      {%- else -%}
                        {{ h.list_dict_filter(search_facets_items, 'name', 'display_name', value) }}
                      {%- endif %}
                      <a href="{{ facets.remove_field(field, value) }}" class="remove" title="{{ _('Remove') }}"><i class="fa fa-times"></i></a>
                    </span>
                  {% endfor %}
                {% endfor %}
              </p>
              <a class="show-filters btn btn-default">{{ _('Filter Results') }}</a>
            {% endif %}
          {% endblock %}
          {% block package_search_results_list %}
            {{ h.snippet('snippets/package_list.html', packages=page.items, list_class='block list--clean list--fullwidth') }}
          {% endblock package_search_results_list %}
          {% block page_pagination %}
            {% if c.page.page_count > 1 %}
              {{ h.snippet('datasetsnippets/snippets/pagination.html',
                page=c.page.page,
                page_count=c.page.page_count,
                cells=h.berlin_pagination_cells(c.page.page, c.page.page_count),
                dataset_path='dataset'
                )
              }}
            {% endif %}
          {% endblock %}
        </div>
      </div>
    </div>
  </div>
{% endblock primary_content %}

{% block grid_post_maincontent %}</form>{% endblock grid_post_maincontent %}